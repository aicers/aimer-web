# yaml-language-server: $schema=https://raw.githubusercontent.com/compose-spec/compose-spec/master/schema/compose-spec.json
services:
  web:
    build:
      context: .
      args:
        - NEXT_PUBLIC_GRAPHQL_ENDPOINT=${NEXT_PUBLIC_GRAPHQL_ENDPOINT}
    image: aimer-web:latest
    env_file:
      - .env
    # Allow container to resolve the host machine as host.docker.internal
    extra_hosts:
      - "host.docker.internal:host-gateway"
    environment:
      # Forward GraphQL endpoint into container for client-side usage
      - NEXT_PUBLIC_GRAPHQL_ENDPOINT=${NEXT_PUBLIC_GRAPHQL_ENDPOINT}
    restart: unless-stopped
  nginx-http:
    image: nginx:1.27
    profiles: ["http"]
    depends_on:
      - web
    ports:
      - "127.0.0.1:${AIMER_HTTP_PORT:-8446}:8080" # host:container
    volumes:
      - ./docker/nginx/default.conf:/etc/nginx/conf.d/default.conf:ro
    restart: unless-stopped

  nginx-https:
    image: nginx:1.27
    profiles: ["https"]
    depends_on:
      - web
    ports:
      - "127.0.0.1:8446:443" # host:container (TLS)
    volumes:
      - ./docker/nginx/default-ssl.conf:/etc/nginx/conf.d/default.conf:ro
      - ./docker/nginx/certs:/etc/nginx/certs:ro
    restart: unless-stopped

networks:
  default:
    name: aimer-web_net
